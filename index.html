<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹ÙˆØ§Øª - Ù…ØªØµÙ„ Ø¨Ù€ Firebase</title>
  <style>
    :root{ --primary:#6c5ce7; --primary-dark:#5a4dcf; --good:#27ae60; --bad:#e74c3c; --muted:#666; }
    body{font-family: "Cairo", Arial, sans-serif; background:#f0f2f5; margin:0; padding:16px; direction:rtl;color:#222;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(90deg,var(--primary),#6dd5fa);color:white;padding:12px;border-radius:10px;margin-bottom:12px;}
    header .brand{display:flex;align-items:center;gap:12px;}
    header img{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.18);}
    header .profile-info{display:flex;flex-direction:column;align-items:flex-end;}
    .container{max-width:980px;margin:0 auto;}
    .card{background:white;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px;}
    label{display:block;margin-bottom:6px;font-weight:600;}
    input,select{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-bottom:8px;}
    button{padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:white;cursor:pointer;}
    button.secondary{background:#ccc;color:#222;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #eee;padding:8px;text-align:center;font-size:14px;}
    th{background:#fafafa;}
    .hidden{display:none;}
    .small-muted{color:var(--muted);font-size:13px;}
    .balance-badge{background:gold;color:#222;padding:6px 12px;border-radius:20px;font-weight:700;}
    @media (max-width:720px){ header{flex-direction:column;align-items:flex-start;} }
  </style>
  <!-- Ù…ÙƒØªØ¨Ø© Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² -->
  <script src="https://openfpcdn.io/fingerprintjs/v4/iife.min.js"></script>
</head>
<body>
  <div class="container">

    <!-- HEADER -->
    <header id="topBar" class="hidden">
      <div class="brand">
        <h2 style="margin:0">ğŸ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø¹ÙˆØ§Øª</h2>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <img id="topProfileImg" src="https://i.imgur.com/placeholder.png" alt="profile">
        <div class="profile-info">
          <strong id="topProfileName">Ù…Ø³ØªØ®Ø¯Ù…</strong>
          <div class="small-muted">ÙƒÙˆØ¯: <span id="topProfileCode">------</span></div>
        </div>
        <div class="balance-badge">Ø§Ù„Ø±ØµÙŠØ¯: <span id="displayBalance">0.00</span>$</div>
      </div>
    </header>

    <!-- AUTH CARD -->
    <div id="authCard" class="card">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input id="loginEmail" type="email" placeholder="email@example.com">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="loginPassword" type="password" placeholder="********">
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button type="button" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button type="button" id="signupBtn" class="secondary">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>
      <p class="small-muted" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: ÙØ¹Ù‘Ù„ Email/Password ÙÙŠ Firebase Console Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙØ¹Ù„Ù‹Ø§.</p>
    </div>

    <!-- USER PANEL: Ø§Ù„Ø¯Ø¹ÙˆØ§Øª -->
    <div id="userCard" class="card hidden">
      <h3>Ø§Ù„Ø¯Ø¹ÙˆØ§Øª ÙˆÙƒØ³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
      <div>
        <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</label>
        <input id="myInviteLink" type="text" readonly style="direction:ltr;width:90%;margin-bottom:8px;">
        <button type="button" id="copyInviteBtn">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
      </div>
      <div style="margin-top:16px;">
        <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©: <span id="inviteCount">0</span></strong>
      </div>
      <div style="margin-top:12px;">
        <ul id="inviteList"></ul>
      </div>
      <p class="small-muted">Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ³Ø¬Ù„ Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·ÙƒØŒ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹! Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù„Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‚Ø¨ÙˆÙ„ Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ø¹ÙˆØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.</p>
    </div>

  </div>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, updateDoc, query, where, onSnapshot, getDocs, getDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const firebaseConfig = {
      apiKey: "AIzaSyDPcyxpHRuLx9T2CO4LJ-n9jaqAynUjvqw",
      authDomain: "xix5-a119a.firebaseapp.com",
      projectId: "xix5-a119a",
      storageBucket: "xix5-a119a.appspot.com",
      messagingSenderId: "332265425367",
      appId: "1:332265425367:web:0a95e71d8bd0058503a392",
      measurementId: "G-RLK4PXMV7P"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const topBar = document.getElementById("topBar");
    const topProfileImg = document.getElementById("topProfileImg");
    const topProfileName = document.getElementById("topProfileName");
    const topProfileCode = document.getElementById("topProfileCode");
    const displayBalance = document.getElementById("displayBalance");

    const authCard = document.getElementById("authCard");
    const userCard = document.getElementById("userCard");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");

    // Ø¯Ø¹ÙˆØ§Øª
    const myInviteLink = document.getElementById("myInviteLink");
    const copyInviteBtn = document.getElementById("copyInviteBtn");
    const inviteCount = document.getElementById("inviteCount");
    const inviteList = document.getElementById("inviteList");

    // fingerprintjs
    let deviceFingerprint = "";
    window.FingerprintJS.load().then(fp => {
      fp.get().then(res => { deviceFingerprint = res.visitorId; });
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    loginBtn.addEventListener("click", async () => {
      const email = loginEmailInput.value.trim();
      const pass = loginPasswordInput.value;
      if(!email || !pass){ alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."); return; }
      try{
        await signInWithEmailAndPassword(auth,email,pass);
      } catch(e){ alert("Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: "+e.message); }
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯Ø¹ÙˆØ©
    signupBtn.addEventListener("click", async () => {
      const email = loginEmailInput.value.trim();
      const pass = loginPasswordInput.value;
      if(!email || !pass){ alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨."); return; }
      // ØªØ­Ù‚Ù‚ Ù…Ù† ref
      const params = new URLSearchParams(window.location.search);
      const refCode = params.get("ref");
      try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø¨Ø§Ù„ÙƒÙˆØ¯
        let inviterId = "";
        if (refCode) {
          const q = query(collection(db, "users"), where("code", "==", refCode));
          const snap = await getDocs(q);
          if (!snap.empty) inviterId = snap.docs[0].id;
        }
        // Ù…Ù†Ø¹ Ù‚Ø¨ÙˆÙ„ Ø¯Ø¹ÙˆØ© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²
        if(inviterId){
          const usersWithDevice = query(collection(db, "users"), where("inviteDeviceId", "==", deviceFingerprint));
          const r = await getDocs(usersWithDevice);
          if(!r.empty){
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø¨ÙˆÙ„ Ø¯Ø¹ÙˆØ© Ù…Ø±ØªÙŠÙ† Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²!");
            return;
          }
        }
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        const uid = cred.user.uid;
        const code = generateCode();
        await setDoc(doc(db,"users",uid),{
          email,
          name:"Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
          balance:0.00,
          photoURL:"https://i.imgur.com/placeholder.png",
          code,
          createdAt: serverTimestamp(),
          inviterId: inviterId || "",
          inviteDeviceId: inviterId ? deviceFingerprint : ""
        });
        // Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ø¯Ø§Ø¹ÙŠ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        if(inviterId){
          const inviterRef = doc(db, "users", inviterId);
          await updateDoc(inviterRef, { balance: increment(0.03) }); // ØºÙŠÙ‘Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ
        }
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
      }catch(e){ alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: "+e.message); }
    });

    onAuthStateChanged(auth, async (user) => {
      if(user){
        authCard.classList.add("hidden");
        topBar.classList.remove("hidden");
        userCard.classList.remove("hidden");

        const userRef = doc(db, "users", user.uid);
        onSnapshot(userRef, snap => {
          if(snap.exists()){
            const data = snap.data();
            topProfileImg.src = data.photoURL || "https://i.imgur.com/placeholder.png";
            topProfileName.textContent = data.name || user.email;
            topProfileCode.textContent = data.code || "------";
            displayBalance.textContent = (Number(data.balance)||0).toFixed(2);
          }
        });

        // === Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„Ø®Ø§Øµ ===
        let userSnap = await getDoc(userRef);
        let data = userSnap.data();
        let myCode = data && data.code ? data.code : generateCode();
        if(!data.code) await setDoc(userRef, { code: myCode }, { merge: true });
        // Ù‡Ù†Ø§ Ø§Ù„Ø±Ø¨Ø· ÙŠÙƒÙˆÙ† Ø¯ÙˆÙ…Ù‹Ø§ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        const inviteURL = "https://xtx3.github.io/x123/?ref=" + myCode;
        myInviteLink.value = inviteURL;
        copyInviteBtn.onclick = function () {
          navigator.clipboard.writeText(inviteURL);
          alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
        };

        // === Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ† ===
        const invitedQ = query(collection(db, "users"), where("inviterId", "==", user.uid));
        onSnapshot(invitedQ, res => {
          inviteCount.textContent = res.size;
          inviteList.innerHTML = "";
          res.forEach(uDoc => {
            const name = uDoc.data().name || uDoc.data().email || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯";
            inviteList.innerHTML += `<li>${name}</li>`;
          });
        });

      } else {
        authCard.classList.remove("hidden");
        userCard.classList.add("hidden");
        topBar.classList.add("hidden");
      }
    });

    function generateCode(){ const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let code=""; for(let i=0;i<8;i++) code+=chars.charAt(Math.floor(Math.random()*chars.length)); return code; }

  </script>
</body>
</html>

